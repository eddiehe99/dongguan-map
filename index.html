<html lang="zh-Hans">

<head>
    <meta charset="UTF-8">
    <title>An Interactive Map of Dongguan 东莞市地图</title>
    <meta name="robots" content="noodp, noydir" />
    <meta name="author" content="Eddie He" />
    <meta name="description"
        content="Learn the name of every town of the famous city: Dongguan 可交互的东莞市地图（政区版），展示了众多镇街的介绍。" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
    <meta name="format-detection" content="telephone=no">

    <meta property="og:url" content="https://dongguan-map.eddiehe.top">
    <meta property="og:type" content="website">
    <meta property="og:title" content="东莞市地图">
    <meta property="og:description" content="可交互的东莞市地图（政区版），展示了众多镇街的介绍。">
    <meta property="og:image" content="https://s.anyway.red/nurburgring/og.png">

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="东莞市地图" />
    <meta name="twitter:description" content="可交互的东莞市地图（政区版），展示了众多镇街的介绍。" />
    <meta name="twitter:site" content="@eddiehe99" />
    <meta name="twitter:image" content="https://s.anyway.red/nurburgring/og.png" />

    <!-- <link rel="preconnect" href="https://s.anyway.red">
    <link rel="preconnect" href="https://anyway.fm"> -->
    <link rel="stylesheet" href="main.css" />

    <!-- <link rel="stylesheet" href="https://s.anyway.red/nurburgring/sm/result.css" /> -->
    <link rel="icon" href="https://s.anyway.red/nurburgring/fav.png">

    <script>
        let lang = 'cn'
    </script>

</head>

<body>
    <div id="app" :class="[showAllCornerNames ? 'show-all-corners' : '', lang ]">
        <div class="track-map">
            <div class="inner">
                <svg id="svg-track" viewBox="0 0 660 530" class="main-svg" width="6600px" height="5300px">
                    <!-- GeoJSON 路径将在这里被添加 -->
                    <!-- <use href="#track" class="base base2" /> -->
                    <use href="#track" class="base" />
                    <!-- <use href="#track" class="progress" /> -->
                    <!-- <g id="cornerGroup" class="corner hidden">
                        <use id="highlighted-segment" href="#track" class="path"></use>
                    </g> -->
                </svg>
                <div id="town-names-container">
                    <!-- 这里的弯道名称将由 D3.js 动态添加 -->
                </div>
            </div>
        </div>
        <div class="desc skew-p">
            <div class="logo">
                <div class="inner skew-n">
                    <!-- <span id="logoTitleCn" class="title-font">纽<span>博格林</span>北<span>环</span>赛道地图</span> -->
                    <span id="logoTitleCn" class="title-font"><span>东莞市地图<span>（政区版）</span></span>
                    <img src="https://s.anyway.red/nurburgring/logo.svg  " alt="纽北赛道地图" />
                </div>
            </div>
            <div class="corner-info">
                <div id="currentCornerInfoContainer" class="inner"> <!-- 初始隐藏，由 JS 控制 -->
                    <!-- 显示当前弯道名称 (中文) -->
                    <div id="currentCornerNameCn" class="primary skew-n title-font"></div>
                    <!-- 显示当前弯道名称 (英文) -->
                    <div id="currentCornerNameEn" class="primary skew-n"></div>
                    <!-- 显示德语名称 -->
                    <div id="currentCornerSecondary" class="secondary skew-n">
                        <span id="currentCornerDe" class="extra"> <!-- 初始隐藏 -->
                            <svg viewBox="0 0 5 3" class="skew-p">
                                <rect id="black_stripe" width="5" height="3" y="0" x="0" fill="#000" />
                                <rect id="red_stripe" width="5" height="2" y="1" x="0" fill="#6C6C6C" />
                                <rect id="gold_stripe" width="5" height="1" y="2" x="0" fill="#DADADA" />
                            </svg>
                            <span id="currentCornerDeText"></span> <!-- 德语名称文本 -->
                        </span>
                    </div>
                    <!-- 显示弯道介绍 (中文) -->
                    <div id="currentCornerMore" class="more skew-n"></div>
                </div>
                <div id="endingMessageContainer" class="inner desc-msg" style="display: none;"> <!-- 初始隐藏 -->
                    <div id="endingMessage" class="ending skew-n">
                        The End
                        <div id="startOverBtn" class='btn skew-p'>
                            <!-- 为不同语言准备按钮文本元素 -->
                            <div id="startOverBtnTextCn" class='skew-n title-font'>回到起点</div>
                            <div id="startOverBtnTextEn" class='skew-n' style="display: none;">Start Over</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <div class="inner skew-n">
                    <!-- <div @click="openModal('text')" role="button" class="link">
                        <template v-if="lang == 'cn'">关于本站</template>
                        <template v-if="lang == 'en'">About</template>
                    </div> -->
                    <div id="aboutLinkText" role="button" class="link">
                        <span id="aboutTextCn" class="lang-text" data-lang="cn">关于本站</span>
                        <span id="aboutTextEn" class="lang-text" data-lang="en" style="display: none;">About</span>
                    </div>
                    <div class="toggle-group" id="darkModeToggleGroup" class="off"> <!-- 移除 :class 和 @click -->
                        <span id="darkModeToggleText">深色模式</span> <!-- 移除 v-if，添加 id 用于 JS 操作 -->
                        <div class="toggle"></div>
                    </div>
                    <div class="toggle-group" id="langToggleGroup" class="off"> <!-- 移除 :class 和 @click -->
                        <span id="langToggleText">中文</span> <!-- 移除 v-if，添加 id 用于 JS 操作 -->
                        <div class="toggle"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 模态框容器 -->
        <!-- id 用于 JS 选择和控制显示/隐藏 -->
        <!-- class 包含 modal 基础样式和 text 类型标识 -->
        <!-- onclick="closeModal()" 绑定点击背景关闭事件 -->
        <div id="modal" class="modal text" onclick="closeModal()">
            <!-- 模态框内容区域 -->
            <!-- class 包含 inner 基础样式 -->
            <!-- onclick="innerModal(event)" 阻止点击内容区域时事件冒泡到背景，防止关闭 -->
            <div class="inner" onclick="innerModal(event)">
                <!-- 模态框内容体 -->
                <!-- id 用于 JS 动态插入内容 -->
                <!-- class 包含 modal-content 基础样式和 skew-n 变形样式 -->
                <!-- onclick="closeModal()" (可选) 如果希望点击内容区域也关闭模态框，可以加上 -->
                <div id="modal-body" class="modal-content skew-n"></div>
                <!-- 模态框关闭按钮 -->
                <!-- class 包含 modal-close 基础样式和 skew-n 变形样式 -->
                <!-- onclick="closeModal()" 绑定点击关闭事件 -->
                <div class="modal-close skew-n" onclick="closeModal()">
                    <!-- 关闭按钮 SVG 图标 -->
                    <svg viewBox="0 0 30 30">
                        <circle cx="15" cy="15" r="12" />
                        <path d="M10 10L20 20M20 10L10 20" />
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <script src='assets/vue-2.6.11.min.js'></script>
    <script src="main.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <!-- <svg id="map-svg"></svg> -->
    <script>
        // 你的 D3.js 代码块
        document.addEventListener("DOMContentLoaded", function () {
            const svg = d3.select("#svg-track");

            d3.json("441900.geojson").then(function (geojsonData) {
                console.log("GeoJSON loaded:", geojsonData);

                const projection = d3.geoMercator()
                    .fitSize([660, 530], geojsonData);

                // --- 新增：计算并存储每个 feature 的 SVG 坐标 ---
                const featureCentroids = new Map(); // 使用 Map 存储 id -> [x, y] 的映射
                geojsonData.features.forEach(feature => {
                    const centroid = d3.geoCentroid(feature);
                    const [x, y] = projection(centroid);
                    featureCentroids.set(feature.properties.id, [x, y]);
                });
                // 将坐标映射存储到全局变量或方便访问的地方，供 update 函数使用
                window.featureCentroids = featureCentroids;
                // --- end 新增 ---

                const pathGenerator = d3.geoPath().projection(projection);

                const bounds = pathGenerator.bounds(geojsonData);
                const dx = bounds[1][0] - bounds[0][0];
                const dy = bounds[1][1] - bounds[0][1];
                const padding = 5;
                const x = bounds[0][0] - padding;
                const y = bounds[0][1] - padding;
                const width = dx + 2 * padding;
                const height = dy + 2 * padding;

                svg.attr("viewBox", `${x} ${y} ${width} ${height}`);

                svg.append("path")
                    .datum(geojsonData)
                    .attr("id", "track")
                    // .attr("class", "geojson-track")
                    .attr("d", pathGenerator)
                    .attr("fill", "none")
                // .attr("stroke", "white")
                // .attr("stroke-width", 2);

                const features = geojsonData.features;

                // --- 修改部分：为每个 Feature 创建 <g> 和 <path> ---
                // 选择 <svg> 容器
                const svgSelection = svg; // 或者 svg.select('g') 如果你有特定的组容器

                // 为每个 Feature 创建一个 <g> 元素
                const cornerGroups = svgSelection.selectAll("g.corner")
                    .data(features)
                    .enter()
                    .append("g") // 创建 <g> 元素
                    .attr("class", "corner") // 给 <g> 添加 'corner' 类和一个基于 id 的唯一类
                    .attr("id", d => `corner-group-${d.properties.id}`); // 给 <g> 添加一个唯一的 ID

                // 在每个 <g> 内部添加对应的 <path> 元素
                cornerGroups
                    .append("path")
                    .attr("id", d => d.properties.id) // 保持你原来的 path ID
                    .attr("class", "path") // 给 <path> 添加 'path' 类，使其匹配 CSS
                    .attr("d", pathGenerator) // 使用 pathGenerator 生成路径
                    .attr("fill", "none")
                    // 注意：不要在这里设置 stroke，因为 CSS 会控制 stroke
                    // .attr("stroke", ...) // 移除或注释掉
                    // .attr("stroke-width", ...) // 移除或注释掉，CSS 会控制
                    ;

                cornerGroups
                    .append("path")
                    .attr("id", d => `${d.properties.id}-progress`) // 添加 -progress 后缀
                    .attr("class", "town-progress") // 用于进度的类
                    .attr("d", pathGenerator) // 使用 pathGenerator 生成路径
                    .attr("fill", "none");

            }).catch(function (error) {
                console.error("Error loading GeoJSON:", error);
            }).finally(function () {
                // --- 关键：在 D3.js Promise 完成（无论成功或失败）后，调用 updateCornerNamesDiv ---
                // 确保 main.js 中的 updateCornerNamesDiv 函数已定义且 window.featureCentroids 已设置
                if (window.updateCornerNamesDiv && window.featureCentroids) {
                    console.log("Calling updateCornerNamesDiv after GeoJSON load.");
                    window.updateCornerNamesDiv(); // 调用 main.js 中的函数
                } else {
                    console.error("updateCornerNamesDiv function or featureCentroids not available.");
                }
            });;

            // --- 为按钮添加事件监听器 (调用 main.js 中定义的函数) ---
            // 确保 main.js 已经执行并定义了这些函数
            document.getElementById('langToggleGroup')?.addEventListener('click', window.toggleLang);
            document.getElementById('darkModeToggleGroup')?.addEventListener('click', window.toggleDarkMode);
            document.getElementById('startOverBtn')?.addEventListener('click', function () { window.setP(0.001); });
            document.getElementById('aboutLinkText')?.addEventListener('click', function () { window.openModal('text'); });

            // --- 初始化 UI (调用 main.js 中的函数) ---
            window.updateUIBasedOnLanguage(window.currentLang || 'cn');
            window.updateUIBasedOnDarkMode(window.isDarkMode || true);
            window.updateCornerNamesDiv(); // 初始化弯道名称显示
        });

        // --- 关键：滚动事件监听器 ---
        // 监听滚动事件 (调用 main.js 中的函数)
        window.addEventListener('scroll', function () {
            // console.log("Scroll event fired!"); // 可选：调试用

            // 更新滚动条指示器 (如果需要)
            const scrollIndicator = document.getElementById('scrollIndicator');
            if (scrollIndicator) {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const docHeight = document.documentElement.scrollHeight - window.innerHeight;
                const currentP = docHeight > 0 ? Math.min(1, scrollTop / docHeight) : 0;
                scrollIndicator.style.width = (currentP * 100) + '%';
            }

            // 调用 main.js 中的更新函数
            // 确保 main.js 中定义了 updateScrollDistance 并且已暴露到 window
            if (typeof window.updateScrollDistance === 'function') {
                // console.log("Calling updateScrollDistance from index.html"); // 可选：调试用
                window.updateScrollDistance(); // 这是关键，调用 main.js 的函数
            } else {
                console.error("updateScrollDistance function not found on window object!");
            }
        });

        // 页面加载后触发一次，设置初始状态
        window.dispatchEvent(new Event('scroll'));

    </script>

</body>

</html>